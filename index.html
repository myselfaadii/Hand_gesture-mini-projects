<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Handâ€‘Tracked 3D Particle System (FINAL FIXED)</title>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <!-- GUI -->
  <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.18/dist/lil-gui.min.js"></script>

  <!-- MediaPipe (ORDER MATTERS!) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#05050a}
    #container{width:100%;height:100%}
    video{position:absolute;right:10px;bottom:10px;width:200px;height:150px;transform:scaleX(-1);border-radius:8px}
  </style>
</head>
<body>

<div id="container"></div>
<video id="video" autoplay muted playsinline></video>

<script>
/******************************************************
 * SPRITE TEXTURE (VISIBLE ALPHA)
 ******************************************************/
function createSprite(color='#ff4d88'){
  const s=128,c=document.createElement('canvas');
  c.width=c.height=s;
  const x=c.getContext('2d');
  const g=x.createRadialGradient(s/2,s/2,0,s/2,s/2,s/2);
  g.addColorStop(0,'rgba(255,255,255,1)');
  g.addColorStop(0.4,color);
  g.addColorStop(1,'rgba(0,0,0,0)');
  x.fillStyle=g;
  x.beginPath();x.arc(s/2,s/2,s/2,0,Math.PI*2);x.fill();
  return new THREE.CanvasTexture(c);
}

/******************************************************
 * THREE.JS SCENE
 ******************************************************/
const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0x05050a,0.6);

const camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,0.01,50);
camera.position.z=1.2;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.getElementById('container').appendChild(renderer.domElement);

/******************************************************
 * PARTICLES
 ******************************************************/
const N=6000;
const base=new Float32Array(N*3);
const pos=new Float32Array(N*3);
const col=new Float32Array(N*3);

for(let i=0;i<N;i++){
  const a=Math.random()*Math.PI*2;
  const r=Math.random()*0.6;
  base[i*3]=Math.cos(a)*r;
  base[i*3+1]=Math.sin(a)*r;
  base[i*3+2]=(Math.random()-0.5)*0.4;
  pos.set(base.slice(i*3,i*3+3),i*3);
  col[i*3]=Math.random();
  col[i*3+1]=Math.random();
  col[i*3+2]=Math.random();
}

const geo=new THREE.BufferGeometry();
geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
geo.setAttribute('base',new THREE.BufferAttribute(base,3));
geo.setAttribute('color',new THREE.BufferAttribute(col,3));

const mat=new THREE.ShaderMaterial({
  transparent:true,
  depthTest:false,
  depthWrite:false,
  blending:THREE.AdditiveBlending,
  vertexColors:true,
  uniforms:{size:{value:18},map:{value:createSprite()}},
  vertexShader:`
    uniform float size;
    varying vec3 vColor;
    void main(){
      vColor=color;
      vec4 mv=modelViewMatrix*vec4(position,1.0);
      gl_PointSize=size*(1.0/-mv.z);
      gl_Position=projectionMatrix*mv;
    }
  `,
  fragmentShader:`
    uniform sampler2D map;
    varying vec3 vColor;
    void main(){
      vec4 t=texture2D(map,gl_PointCoord);
      if(t.a<0.1) discard;
      gl_FragColor=vec4(vColor*t.rgb,t.a);
    }
  `
});

const points=new THREE.Points(geo,mat);
scene.add(points);

/******************************************************
 * MEDIAPIPE HANDS (WORKING)
 ******************************************************/
const video=document.getElementById('video');
let pinch=0.06,hx=0,hy=0;

const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.6
});

hands.onResults(r=>{
  if(!r.multiHandLandmarks||r.multiHandLandmarks.length===0) return;
  const lm=r.multiHandLandmarks[0];
  const a=lm[4],b=lm[8]; // thumb & index
  pinch=Math.hypot(a.x-b.x,a.y-b.y);
  hx=(0.5-a.x)*2;
  hy=(a.y-0.5)*2;
  console.log('Hand detected | pinch=',pinch.toFixed(3));
});

const cam=new Camera(video,{
  onFrame:async()=>{await hands.send({image:video});},
  width:640,height:480
});
cam.start();

/******************************************************
 * ANIMATION LOOP
 ******************************************************/
function animate(){
  requestAnimationFrame(animate);

  const exp=1+(pinch-0.06)*10;
  const p=geo.attributes.position.array;
  const b=geo.attributes.base.array;

  for(let i=0;i<N;i++){
    p[i*3]+= (b[i*3]*exp - p[i*3]) * 0.05;
    p[i*3+1]+= (b[i*3+1]*exp - p[i*3+1]) * 0.05;
    p[i*3+2]+= (b[i*3+2]*exp - p[i*3+2]) * 0.05;
  }
  geo.attributes.position.needsUpdate=true;

  camera.position.x+= (hx-camera.position.x)*0.05;
  camera.position.y+= (hy-camera.position.y)*0.05;
  camera.lookAt(0,0,0);

  points.rotation.y+=0.002;
  renderer.render(scene,camera);
}
animate();

window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
